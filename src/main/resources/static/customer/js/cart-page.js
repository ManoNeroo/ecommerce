!function(){const t=5,e=document.querySelector("#select-all-cart-item input"),n=document.getElementById("delete-all-cart-item"),i=document.getElementById("open-cart-modal"),a=document.getElementById("cart-form"),c=document.getElementById("fullName-error"),d=document.getElementById("phoneNumber-error"),r=document.getElementById("address-error"),o=a.querySelector("input[name='fullName']"),l=a.querySelector("input[name='phoneNumber']"),s=a.querySelector("input[name='address']");o.addEventListener("focus",()=>c.innerText=""),l.addEventListener("focus",()=>d.innerText=""),s.addEventListener("focus",()=>r.innerText=""),l.addEventListener("keyup",t=>{const{target:e}=t;let{value:n}=e;n=n.replace(/\D/g,""),e.value=n});const u=new class{constructor(t){this.element=document.querySelector(t),this.data=[],this.numberChecked=0}onEditItem(t){this.element.addEventListener("editItem",e=>{t(e.detail.itemList)})}onRemoveItem(t){this.element.addEventListener("removeItem",e=>{t(e.detail.itemList)})}setData(n){if(Array.isArray(n)&&this.element){let i=!0;n.forEach(n=>{n.checked?this.numberChecked++:i=!1,this.data.push(n);const a=function(e){const n=document.createElement("div");return n.className="cart-item",n.setAttribute("data-id",e.product.id),n.innerHTML=`<label class="checkbox cart-col">\n                            <input type="checkbox" ${e.checked?"checked":""}>\n                            <i></i>\n                        </label>\n                        <div class="cart-item-picture cart-col">\n                            <img src="${e.product.avatar}" alt="${e.product.name}">\n                        </div>\n                        <div class="cart-item-info cart-col">\n                            <div class="item-name">\n                                <a href="${"/product/"+e.product.id}">${e.product.name}</a>\n                            </div>\n                            <div class="list-star"></div>\n                        </div>\n                        <div class="cart-item-price cart-col pl-2 pr-2">\n                        ${formatNumber(e.product.promoPrice)}₫\n                        </div>\n                        <div class="cart-item-quanlity cart-col pl-2 pr-2">\n                            <div class="quanlity-btn">\n                                <button type="button" class="element btn-minus-quanlity${e.quanlity>1?"":" disable"}">\n                                    <svg viewBox="0 0 10 10">\n                                        <polygon\n                                            points="4.5 4.5 3.5 4.5 0 4.5 0 5.5 3.5 5.5 4.5 5.5 10 5.5 10 4.5">\n                                        </polygon>\n                                    </svg>\n                                </button>\n                                <span class="quanlity-input element">${e.quanlity}</span>\n                                <button type="button" class="element btn-plus-quanlity${e.quanlity<t?"":" disable"}">\n                                    <svg viewBox="0 0 10 10">\n                                        <polygon\n                                            points="10 4.5 5.5 4.5 5.5 0 4.5 0 4.5 4.5 0 4.5 0 5.5 4.5 5.5 4.5 10 5.5 10 5.5 5.5 10 5.5">\n                                        </polygon>\n                                    </svg>\n                                </button>\n                            </div>\n                        </div>\n                        <div class="cart-item-price cart-col pl-2 pr-2 item-total">\n                        ${formatNumber(e.product.promoPrice*e.quanlity)}₫\n                        </div>\n                        <div class="cart-item-action cart-col pl-2 pr-2">\n                            <span class="cart-delete">\n                                <span class="icon">\n                                    <svg viewBox="0 0 24 24">\n                                        <path\n                                            d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z">\n                                        </path>\n                                    </svg>\n                                </span>\n                            </span>\n                        </div>`,n}(n),c=a.querySelector(".btn-plus-quanlity"),d=a.querySelector(".btn-minus-quanlity"),r=a.querySelector(".cart-delete"),o=a.querySelector(".checkbox input"),l={cartListObj:this,itemData:n};c.addEventListener("click",function(e){e.preventDefault();let{cartListObj:n,itemData:i}=this;if(i.quanlity<i.product.quanlity&&i.quanlity<t){let t=i.quanlity+1;toggleLoading(!0),httpClient("/api/cartitem","PUT",{cartId:g_sUserName,productId:i.product.id,quanlity:t,checked:i.checked}).then(e=>{toggleLoading(!1),e.isSuccess&&(i.quanlity=t,n.editItem(i))}).catch(t=>{console.log(t),toggleLoading(!1)})}}.bind(l)),d.addEventListener("click",function(t){t.preventDefault();let{cartListObj:e,itemData:n}=this;if(n.quanlity>1){let t=n.quanlity-1;toggleLoading(!0),httpClient("/api/cartitem","PUT",{cartId:g_sUserName,productId:n.product.id,quanlity:t,checked:n.checked}).then(i=>{toggleLoading(!1),i.isSuccess&&(n.quanlity=t,e.editItem(n))}).catch(t=>{console.log(t),toggleLoading(!1)})}}.bind(l)),r.addEventListener("click",function(t){t.preventDefault();let{cartListObj:e,itemData:n}=this;window.confirm("Xác nhận xóa sản phẩm khỏi giỏ hàng!")&&(toggleLoading(!0),httpClient("/api/cartitem","DELETE",{cartId:g_sUserName,productId:n.product.id}).then(t=>{toggleLoading(!1),t.isSuccess&&e.removeItem(n.product.id)}).catch(t=>{console.log(t),toggleLoading(!1)}))}.bind(l)),o.addEventListener("change",function(t){t.preventDefault();let{cartListObj:n,itemData:i}=this;const{checked:a}=t.target;toggleLoading(!0),httpClient("/api/cartitem","PUT",{cartId:g_sUserName,productId:i.product.id,quanlity:i.quanlity,checked:a}).then(t=>{toggleLoading(!1),t.isSuccess&&(i.checked=a,n.editItem(i),a?n.numberChecked++:n.numberChecked--,n.numberChecked==n.data.length?e.checked=!0:e.checked=!1)}).catch(t=>{console.log(t),toggleLoading(!1)})}.bind(l)),this.element.appendChild(a)}),i&&(e.checked=!0)}}editItem(e){let n=this.data.findIndex(t=>t.product.id==e.product.id);if(-1!=n){const i=this.data[n];if(e.quanlity<=i.product.quanlity&&e.quanlity<=t){const a=this.element.querySelector(`.cart-item[data-id='${e.product.id}']`),c=a.querySelector(".btn-plus-quanlity"),d=a.querySelector(".btn-minus-quanlity"),r=a.querySelector(".quanlity-input"),o=a.querySelector(".item-total");a.querySelector(".checkbox input").checked=e.checked,d.classList.remove("disable"),c.classList.remove("disable"),r.innerText=e.quanlity,o.innerHTML=formatNumber(e.quanlity*i.product.promoPrice)+"₫",e.quanlity==t&&c.classList.add("disable"),1==e.quanlity&&d.classList.add("disable"),this.data.splice(n,1,e);const l=new CustomEvent("editItem",{detail:{itemList:this.data}});this.element.dispatchEvent(l)}}}removeItem(t){const e=this.data.findIndex(e=>e.product.id==t);if(-1!=e){this.element.querySelector(`.cart-item[data-id='${t}']`).remove(),this.data.splice(e,1);const n=new CustomEvent("removeItem",{detail:{itemList:this.data}});this.element.dispatchEvent(n)}}}("#item-list");function m(t){if(Array.isArray(t)){const e=document.getElementById("cart-summary-body"),n=document.getElementById("cart-summary-total");if(e&&n){let i=0;e.innerHTML="",t.forEach(t=>{if(t.checked){const n=document.createElement("tr"),a=t.quanlity*t.product.promoPrice;n.innerHTML=`<td class="item-name">${t.product.name}</td>\n                                <td>${t.quanlity}</td>\n                                <td>${formatNumber(a)}₫</td>`,i+=a,e.appendChild(n)}}),0==i&&(e.innerHTML='<tr id="summary-null">\n                                        <td class="item-name">Chưa có sản phẩm nào!</td>\n                                        <td></td>\n                                        <td></td>\n                                    </tr>'),n.innerText=formatNumber(i)+"₫"}}}u.setData(g_oCart.cartItems),m(g_oCart.cartItems),u.onEditItem(t=>{m(t)}),u.onRemoveItem(t=>{const e=document.querySelector(".header-top-menu ul .cart .number-item"),n=t.length;if(n>=1)e.innerText=n,m(t);else{e.remove();const t=document.getElementById("cart-item-list"),n=document.getElementById("cart-null");t&&t.classList.add("d-none"),n&&n.classList.remove("d-none")}}),e.addEventListener("change",function(t){t.preventDefault();const{target:e}=t;e.checked?u.numberChecked=u.data.length:u.numberChecked=0;u.data.forEach(async t=>{if(t.checked!=e.checked){toggleLoading(!0);const n=await httpClient("/api/cartitem","PUT",{cartId:g_sUserName,productId:t.product.id,quanlity:t.quanlity,checked:e.checked});n.isSuccess&&(t.checked=e.checked,u.editItem(t)),toggleLoading(!1)}})}),n.addEventListener("click",function(t){t.preventDefault(),window.confirm("Xác nhận xóa tất cả sản phẩm khỏi giỏ hàng!")&&u.data.forEach(async t=>{toggleLoading(!0);const e=await httpClient("/api/cartitem","DELETE",{cartId:g_sUserName,productId:t.product.id});e.isSuccess&&u.removeItem(t.product.id),toggleLoading(!1)})}),i.addEventListener("click",function(){if(u.numberChecked>0){const t=document.querySelector("#cart-modal tbody");t.innerHTML="";let e=0;u.data.forEach((n,i)=>{if(n.checked){const a=document.createElement("tr"),c=n.quanlity*n.product.promoPrice,d=n.quanlity*n.product.price;e+=c,a.innerHTML=`<td>${i+1}</td>\n                    <td class="d-flex">\n                        <div class="cart-item-picture">\n                            <img src="${n.product.avatar}"\n                                alt="${n.product.name}">\n                        </div>\n                        <div class="cart-item-info ml-2">\n                            <div class="item-name">\n                                <a href="/product/${n.product.id}">${n.product.name}</a>\n                            </div>\n                            <div class="list-star"></div>\n                        </div>\n                    </td>\n                    <td>${n.quanlity}</td>\n                    <td>\n                        <div class="cart-item-price">\n                            ${formatNumber(n.quanlity*n.product.promoPrice)}₫\n                        </div>\n                        <div class="cart-item-price root-price">\n                            <del>${d!=c?formatNumber(n.quanlity*n.product.price)+"₫":""}</del>\n                        </div>\n                    </td>`,t.appendChild(a)}});const n=document.createElement("tr");n.className="total",n.innerHTML=`<td></td>\n            <td class="d-flex"></td>\n            <td >Tổng cộng</td>\n            <td>\n                <div class="cart-item-price">\n                    ${formatNumber(e)}₫\n                </div>\n            </td>`,t.appendChild(n),$("#cart-modal").modal("show")}}),a.addEventListener("submit",async function(t){t.preventDefault();const e=getFormData(a);if(function(t){let{fullName:e,phoneNumber:n,address:i}=t;e=e.trim(),n=n.trim(),i=i.trim();let a=!0;""==e?(c.innerText="Nhập tên khách hàng!",a=!1):/^[a-z][a-z\d\s]{2,}$/gi.test(removeAccent(e))||(c.innerText="Tên khách hàng không hợp lệ!",a=!1);""==n?(d.innerText="Nhập số điện thoại!",a=!1):/^\d{10,11}$/.test(n)||(d.innerText="Số điện thoại không hợp lệ!",a=!1);""==i?(r.innerText="Nhập địa chỉ giao hàng!",a=!1):/^[\w\s\.,\\)(/-]{6,}$/i.test(removeAccent(i))||(r.innerText="Địa chỉ không hợp lệ!",a=!1);return a}(e)){toggleLoading(!0);const t=await httpClient("/api/order","POST",{userId:g_iUserId,userName:g_sUserName,fullName:e.fullName,gender:e.gender,address:e.address,phoneNumber:e.phoneNumber,description:e.description});if(t.isSuccess){const e=t.data.id;await async function(t,e,n,i,a){return await httpClient("/api/notification","POST",{content:e,link:n,topicId:i,image:a,title:t})}("Thông báo đơn hàng",`Người dùng <span style="font-weight: bold">${g_sUserName}</span> đã đặt một đơn hàng`,`/admin/order/${e}`,"TOPIC_ADMIN","/common/mylib/img/order.png"),window.location.replace("/user/order/success?id="+e)}else showAlert("failed","Thất bại","Có lỗi xảy ra, vui lòng thử lại!");toggleLoading(!1)}})}();