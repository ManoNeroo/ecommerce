(function(){U();const t=new URLSearchParams(window.location.search).get("tab");if(null!=t){const e=document.getElementById("nav-link-"+t);setTimeout(function(){e&&e.click()},100)}const e=document.querySelectorAll("#product-slider .swiper-slide"),n=document.getElementById("btn-addtocart"),a=document.getElementById("btn-buynow"),i=document.querySelector("#vote .user-comment"),o=document.querySelector("#comment .user-comment"),s=document.getElementById("nav-link-comment"),c=document.getElementById("nav-link-vote"),r=(d=new SockJS("/messages"),stompClient=Stomp.over(d),stompClient);var d;r.debug=function(t){};let l=!1,u={};e.length>1&&(l=!0,u={delay:6e3,disableOnInteraction:!1}),new Swiper("#product-slider",{loop:l,autoplay:u}),new TechnicalDataTable("#product-technical-data").setData(JSON.parse(g_oProduct.technicalData));const m=document.querySelector(".price-main"),p=document.querySelector(".price-sub del"),g=document.getElementById("product-rate-list-progress"),h=document.getElementById("btn-expand-article"),v=document.getElementById("product-article"),b=document.getElementById("open-user-rate-btn");async function f(t){if(g_bIsAuthenticated)if(checkRole(g_aUserRoles,0)){const{comment:e,commentId:n}=t.detail;let a={isSuccess:!1};(a=0==n?await httpClient("/api/comment","POST",{productId:g_oProduct.id,userId:g_iUserId,content:e,parentId:0}):await httpClient("/api/comment","PUT",{productId:g_oProduct.id,content:e,id:n})).isSuccess?(t.target.querySelector("textarea").value="",0==n&&x("Thông báo câu hỏi về sản phẩm",`<span style="font-weight: bold">${g_sUserFullName}</span> đã gửi câu hỏi về sản phẩm <span style="font-weight: bold">${g_oProduct.name}</span>`,`/product/${g_oProduct.id}?userId=${g_iUserId}&tab=comment#myTabContent`,"TOPIC_ADMIN",g_sUserAvatar)):showAlert("failed","Thất bại","Đã có lỗi xảy ra, vui lòng thử lại!")}else showDialog("inform","danger","Thông báo","Tính năng này không dành cho tài khoản của bạn!");else q()}async function y(t=1){const e=new URLSearchParams(window.location.search).get("userId");let n=`/api/comment/filter?page=${t}&limit=10&productId=${g_oProduct.id}`;null!=e?n+="&userId="+e:g_bIsAuthenticated&&(n+="&userId="+g_iUserId),toggleLoading(!0);const a=await httpClient(n);return o.innerHTML="",o.setAttribute("data-page",t),a.isSuccess&&a.data.forEach(t=>{const e=_(t);e.setAttribute("data-id",t.id),o.appendChild(e)}),toggleLoading(!1),a}function w(t,e=0){const n=document.querySelector("#comment .product-comment-box");n.innerHTML="";const a=D("Viết câu hỏi của bạn...","Mời bạn viết bình luận.(Tối thiểu 3 ký tự)","Gửi câu hỏi",t);return a.addEventListener("submitForm",function(t){const n=new CustomEvent("submitComment",{detail:{comment:t.detail,commentId:e}});a.dispatchEvent(n)}),n.appendChild(a),a}function I(t,e){if(0==e.parentId){const n=t.querySelector(`div[data-id='${e.id}']`);n&&n.remove(),e.star&&U()}else{const n=t.querySelector(`div[data-id='${e.parentId}']`),a=n&&n.querySelector(`.comment-box.level2[data-id='${e.id}']`);a&&a.remove()}}function E(t,e){if(0==e.parentId){const n=t.querySelector(`div[data-id='${e.id}']`);if(n){const t=M(e,g_bIsAuthenticated?g_iUserId:null,!1),a=n.querySelector(`.comment-box[data-id='${e.id}']`);a.insertAdjacentElement("afterend",t),a.remove()}else{const n=_(e);if(n.setAttribute("data-id",e.id),1==Number(t.dataset.page)){10==t.childElementCount&&t.lastElementChild.remove(),t.insertAdjacentElement("afterbegin",n)}}e.star&&U()}else{const n=t.querySelector(`div[data-id='${e.parentId}']`);if(n){const t=M(e,g_bIsAuthenticated?g_iUserId:null,!0),a=n.querySelector(`.comment-box.level2[data-id='${e.id}']`);a?(a.insertAdjacentElement("afterend",t),a.remove()):n.appendChild(t)}}}async function S(){const t=await T();if(t.isSuccess&&t.data.length>0){new Pagination({rowCount:t.totalItem,pageSize:t.limit,defaultPage:1},"#evaluation-pagination").onChangePage(async t=>{await T(t),document.getElementById("myTabContent").scrollIntoView()})}}async function T(t=1){const e=new URLSearchParams(window.location.search).get("userId");let n=`/api/evaluation/filter?page=${t}&limit=10&productId=${g_oProduct.id}`;null!=e?n+="&userId="+e:g_bIsAuthenticated&&(n+="&userId="+g_iUserId),toggleLoading(!0);const a=await httpClient(n);return i.innerHTML="",i.setAttribute("data-page",t),a.isSuccess&&a.data.forEach(t=>{const e=_(t);e.setAttribute("data-id",t.id),i.appendChild(e)}),toggleLoading(!1),a}function _(t){const e=document.createElement("div"),n=g_bIsAuthenticated?g_iUserId:null,a=M(t,n,!1);return e.appendChild(a),null!=t.children&&t.children.forEach(t=>{const a=M(t,n,!0);e.appendChild(a)}),e}function C(t="",e=null){const n=document.createElement("div"),a=document.createElement("div"),i=D("Viết câu trả lời của bạn","Mời bạn viết bình luận.(Tối thiểu 3 ký tự)","Trả lời",t);return n.className="row",a.className="col",n.appendChild(a),a.appendChild(i),i.addEventListener("submitForm",t=>{const a=new CustomEvent("submitForm",{detail:{id:e,comment:t.detail}});n.dispatchEvent(a)}),n}async function L(t){const{comment:e,parentId:n,star:a,target:i,id:o}=t;a?await A("/api/evaluation",{productId:g_oProduct.id,content:e,star:a,id:o,userId:g_iUserId,parentId:n},i):await A("/api/comment",{productId:g_oProduct.id,content:e,id:o,userId:g_iUserId,parentId:n},i)}async function A(t,e,n){let a={isSuccess:!1},i="POST";e.id?(i="PUT",a=await httpClient(t,i,e)):a=await httpClient(t,i,e),a.isSuccess?(n.remove(),"POST"==i&&async function(t){let e={isSuccess:!1};e=t.star?await httpClient("/api/evaluation/"+t.parentId):await httpClient("/api/comment/"+t.parentId);if(e.isSuccess){const n=e.data.userAccount;g_iUserId!=n.id&&(t.star?x("Thông báo trả lời đánh giá",`<span style="font-weight: bold">${g_sUserFullName}</span> đã trả lời đánh giá của bạn về sản phẩm <span style="font-weight: bold">${g_oProduct.name}</span>`,`/product/${g_oProduct.id}?userId=${n.id}#myTabContent`,"TOPIC_USER_"+n.userName.toUpperCase(),g_sUserAvatar):x("Thông báo trả lời câu hỏi",`<span style="font-weight: bold">${g_sUserFullName}</span> đã trả lời câu hỏi của bạn về sản phẩm <span style="font-weight: bold">${g_oProduct.name}</span>`,`/product/${g_oProduct.id}?userId=${n.id}&tab=comment#myTabContent`,"TOPIC_USER_"+n.userName.toUpperCase(),g_sUserAvatar))}}(e)):showAlert("failed","Thất bại","Đã có lỗi xảy ra, vui lòng thử lại!")}async function P(t){const{comment:e,star:n,evaluationId:a}=t.detail;let i={isSuccess:!1};(i=0==a?await httpClient("/api/evaluation","POST",{productId:g_oProduct.id,userId:g_iUserId,content:e,star:n,parentId:0}):await httpClient("/api/evaluation","PUT",{productId:g_oProduct.id,content:e,star:n,id:a})).isSuccess?(t.target.remove(),0==a&&x("Thông báo đánh giá sản phẩm",`<span style="font-weight: bold">${g_sUserFullName}</span> đã đánh giá sản phẩm <span style="font-weight: bold">${g_oProduct.name}</span> '${n}' sao`,`/product/${g_oProduct.id}?userId=${g_iUserId}#myTabContent`,"TOPIC_ADMIN",g_sUserAvatar)):showAlert("failed","Thất bại","Đã có lỗi xảy ra, vui lòng thử lại!")}async function x(t,e,n,a,i){await httpClient("/api/notification","POST",{content:e,link:n,topicId:a,image:i,title:t})}async function U(){const t=await httpClient("/api/productstar/"+g_oProduct.id);if(t.isSuccess){const a=t.data,i=["oneStar","twoStars","threeStars","fourStars","fiveStars"];g.innerHTML="";for(let t=5;t>0;t--){let e=N(a.numberEvaluation,a[i[t-1]],t);g.appendChild(e)}e=a.avgStar,n=a.numberEvaluation,document.querySelectorAll(".product-star-list-wrapper").forEach(t=>{const a=t.querySelector(".product-star-list"),i=t.querySelector(".product-star-list-label"),o=t.querySelector(".product-star-list-point"),s=generateStarList(e,"size-2");a.innerHTML="",a.appendChild(s),i&&(i.innerText=n+" đánh giá"),o&&(o.innerText=s.dataset.star)})}var e,n}async function k(t){const e={cartId:g_sUserName,productId:g_oProduct.id,quanlity:1,checked:t};toggleLoading(!0);const n=await httpClient("/api/cartitem","POST",e);return toggleLoading(!1),n.isSuccess}function q(){const t=document.querySelector("#sign form"),e=window.location.origin+"/login?returnUrl="+window.location.pathname;t.setAttribute("action",e),$("#sign").modal("show")}function N(t,e,n){const a=document.createElement("div"),i=0!=t?100*(e/t).toFixed(2):0;return a.className="product-rate-item",a.innerHTML=`<label><span>${n}</span><span><svg viewBox="0 0 24 24">\n        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"></path>\n        </svg></span></label><div class="product-rate-progress-bar">\n        <span class="product-rate-progress-value" style="width: ${i}%"></span></div><span>${e}</span>`,a}function B(t,e,n,a,i="",o=0){let s=t;const c=document.createElement("div");c.innerHTML='<div class="row"><div class="col"><div class="user-rate-star">\n        <p>Bạn chấm sản phẩm này bao nhiêu sao?</p><div class="list-star"></div></div></div>\n        <div class="col-8"></div></div>',c.className="product-user-rate";const r=c.querySelector(".list-star"),d=c.querySelector(".col-8"),l=D(e,n,a,i),u=function(t,e){const n=["Không thích","Tạm được","Bình thường","Hài lòng","Tuyệt vời"];let a=t>=1&&t<=5?t:5;const i="<svg viewBox='0 0 24 24'><path d='M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z'></path></svg>",o="<svg viewBox='0 0 24 24'><path d='m22 9.24-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03L22 9.24zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28L12 15.4z'></path></svg>",s=document.createElement("div"),c=document.createElement("ul"),r=document.createElement("span"),d="star-list "+e;s.append(c,r),s.setAttribute("data-star",a),c.className=d,r.innerText=n[t-1];for(let t=1;t<=5;t++){const e=document.createElement("li");e.setAttribute("data-star",t),e.innerHTML=t<=a?i:o,e.addEventListener("mouseover",()=>l(e)),c.appendChild(e)}function l(t){const e=Number(t.dataset.star),a=c.querySelectorAll("li"),d=isNaN(e)||0==e?5:e,l=new CustomEvent("changeStar",{detail:d});s.dispatchEvent(l),r.innerText=n[d-1],a.forEach(t=>{const e=Number(t.dataset.star),n=isNaN(e)||0==e?5:e;t.innerHTML=n<=d?i:o})}return s}(s,"size-3");return u.addEventListener("changeStar",t=>s=t.detail),l.addEventListener("submitForm",t=>{let{detail:e}=t,n=new CustomEvent("submitRate",{detail:{evaluationId:o,star:s,comment:e}});c.dispatchEvent(n)}),r.appendChild(u),d.appendChild(l),c}function D(t,e,n,a=""){const i=document.createElement("div");i.innerHTML=`<textarea rows="4" placeholder="${t}">${a}</textarea>\n        <p class="error text-danger"></p><button class="btn btn-danger">${n}</button>`,i.className="user-comment-form";const o=i.querySelector(".btn"),s=i.querySelector(".error");return i.querySelector("textarea").onfocus=function(){s.innerText=""},o.onclick=function(t){t.preventDefault();const n=i.querySelector("textarea").value.trim();if(n.length>=3){const t=new CustomEvent("submitForm",{detail:n});i.dispatchEvent(t)}else s.innerText=e},i}function M(t,e,n=!1){const a=document.createElement("div"),i=t.createdAt.slice(0,10).split("-").reverse().join("-");if(t.target=a,a.className="comment-box",a.setAttribute("data-id",t.id),a.innerHTML=`<div class="comment-box-avatar${n?" d-none":""}"><img src="${t.userAccount.avatar}"></div>\n        <div class="comment-box-content"><div class="comment-name">${t.userAccount.fullName}</div>\n        <div class="list-star"><span>vào ngày ${i}</span></div><div class="comment-text">\n        ${t.content}</div><div class="comment-action">${n?"":'<span class="action-reply">Trả lời</span>'}\n        ${e==t.userAccount.id?'<span class="action-edit">Sửa</span><span class="action-delete">Xóa</span>':""}\n        </div></div>`,n&&(a.classList.add("level2"),a.setAttribute("data-parent",t.parentId)),t.star&&!n){const e=a.querySelector(".list-star"),n=generateStarList(t.star,"size-1");e.insertAdjacentElement("afterbegin",n)}if(e==t.userAccount.id){const e=a.querySelector(".action-edit"),n=a.querySelector(".action-delete");e.onclick=function(){!function(t){if(g_bIsAuthenticated){const{content:e,star:n,parentId:a,id:i,target:o}=t;if(0==a)if(n){const t=document.querySelector(".product-rate-star"),a=t.nextElementSibling;a.classList.contains("product-user-rate")&&a.remove();const o=B(n,"Cho chúng tôi biết đánh giá của bạn về sản phẩm?","Mời bạn viết bình luận.(Tối thiểu 3 ký tự)","Gửi đánh giá",e,i);o.addEventListener("submitRate",P),t.insertAdjacentElement("afterend",o)}else w(e,i).addEventListener("submitComment",f);else{const t=o.nextElementSibling;if(t){if(!t.classList.contains("row")){const t=o.parentElement,a=C(e,i);t.appendChild(a),a.addEventListener("submitForm",t=>L({parentId:i,star:n,comment:t.detail.comment,target:t.target,id:t.detail.id}))}}else{const t=o.parentElement,a=C(e,i);t.appendChild(a),a.addEventListener("submitForm",t=>L({parentId:i,star:n,comment:t.detail.comment,target:t.target,id:t.detail.id}))}}}else q()}(t)},n.onclick=function(){!async function(t){g_bIsAuthenticated?showDialog("confirm","warning","Cảnh báo","Bạn có chắc chắn muốn xóa comment này!").addEventListener("confirm",async()=>{const{id:e,star:n,parentId:a,target:i}=t;let o={isSuccess:!1};if(n){if(0==a){const t=document.querySelector(".product-rate-star").nextElementSibling;t.classList.contains("product-user-rate")&&t.remove()}else{const t=i.nextElementSibling;t&&(t.className="row")&&t.remove()}o=await httpClient("/api/evaluation/"+e,"DELETE")}else{if(0==a)w("").addEventListener("submitComment",f);else{const t=i.nextElementSibling;t&&(t.className="row")&&t.remove()}o=await httpClient("/api/comment/"+e,"DELETE")}o.isSuccess||showAlert("failed","Thất bại","Đã có lỗi xảy ra, vui lòng thử lại!")}):q()}(t)}}const o=a.querySelector(".action-reply");return o&&(o.onclick=function(){!function(t){if(g_bIsAuthenticated){const{id:e,userAccount:n,star:a,target:i}=t;if(checkRole(g_aUserRoles,1)||checkRole(g_aUserRoles,2)||checkRole(g_aUserRoles,3)||n.id==g_iUserId||null==a){const t=i.nextElementSibling;if(t){if(!t.classList.contains("row")){const t=i.parentElement,n=C();t.appendChild(n),n.addEventListener("submitForm",t=>L({parentId:e,star:a,comment:t.detail.comment,target:t.target}))}}else{const t=i.parentElement,n=C();t.appendChild(n),n.addEventListener("submitForm",t=>L({parentId:e,star:a,comment:t.detail.comment,target:t.target}))}}else showDialog("inform","danger","Thông báo","Bạn không thể trả lời bình luận này!")}else q()}(t)}),a}m.innerText=formatNumber(g_oProduct.promoPrice)+"₫",p.innerText=formatNumber(g_oProduct.price)+"₫",h.addEventListener("click",function(t){t.preventDefault();const e=h.parentElement;v.style.height="auto",v.style.position="relative",e.remove()}),n.addEventListener("click",async function(t){if(t.preventDefault(),g_bIsAuthenticated)if(checkRole(g_aUserRoles,0)){const t=await k(!1);t?(showAlert("success","Thành công","Đã thêm sản phẩm vào giỏ hàng"),loadCartNumberItem()):showAlert("failed","Thất bại","Đã xảy ra lỗi khi thêm sản phẩm vào giỏ hàng!")}else showDialog("inform","danger","Thông báo","Tính năng này không dành cho tài khoản của bạn!");else q()}),a.addEventListener("click",async function(t){if(t.preventDefault(),t.preventDefault(),g_bIsAuthenticated)if(checkRole(g_aUserRoles,0)){const t=await k(!0);if(t){const t=window.location.origin+"/user/cart";window.location.href=t}else showAlert("failed","Thất bại","Đã xảy ra lỗi khi thêm sản phẩm vào giỏ hàng!")}else showDialog("inform","danger","Thông báo","Tính năng này không dành cho tài khoản của bạn!");else q()}),b.addEventListener("click",async function(t){if(t.preventDefault(),g_bIsAuthenticated){const t=await httpClient(`/api/purchased/checkpurchased?userId=${g_iUserId}&productId=${g_oProduct.id}`);if(t.isSuccess)if(2==t.data){const t=document.querySelector(".product-rate-star"),e=t.nextElementSibling;if(!e.classList.contains("product-user-rate")){const e=B(5,"Cho chúng tôi biết đánh giá của bạn về sản phẩm?","Mời bạn viết bình luận.(Tối thiểu 3 ký tự)","Gửi đánh giá","");e.addEventListener("submitRate",P),t.insertAdjacentElement("afterend",e)}}else 1==t.data?showDialog("inform","danger","Thông báo","Bạn đã đánh giá sản phẩm này rồi!"):0==t.data&&showDialog("inform","danger","Thông báo","Bạn chưa mua sản phẩm này!");else showDialog("inform","danger","Thông báo","Bạn chưa mua sản phẩm này!")}else q()}),s.addEventListener("click",async function(){w("").addEventListener("submitComment",f);const t=await y();if(t.isSuccess&&t.data.length>0){const e=new Pagination({rowCount:t.totalItem,pageSize:t.limit,defaultPage:1},"#comment-pagination");e.onChangePage(async t=>{await y(t),document.getElementById("myTabContent").scrollIntoView()})}}),c.addEventListener("click",S),r.connect({},function(t){r.subscribe("/topic/productcomment/"+g_oProduct.id,function(t){var e;t.body&&((e=JSON.parse(t.body)).createdAt?e.star?E(i,e):E(o,e):e.star?I(i,e):I(o,e))})}),S()})();